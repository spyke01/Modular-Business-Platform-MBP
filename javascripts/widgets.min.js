var mbpWidgets={init:function(){var e,i=$("div.widgets-sortables");$("#widgets-rightCol").children(".ui-widget").children(".header").click(function(){mbpWidgets.collapse(this)}),$("#widgets-rightCol").children(".box").children(".box-header").click(function(){mbpWidgets.collapse(this)}),$("#available-widgets").children(".box-header").click(function(){mbpWidgets.collapse(this)}),$(document).on("click","a.widget-action",function(){var e=$(this).closest("div.widget").children(".widget-inside");return e.is(":hidden")?e.slideDown("fast"):e.slideUp("fast"),!1}),$(document).on("click","input.widget-control-save",function(){return mbpWidgets.save($(this).closest("div.widget"),0,1,0),!1}),$(document).on("click","a.widget-control-remove",function(){return mbpWidgets.save($(this).closest("div.widget"),1,1,0),!1}),$(document).on("click","a.widget-control-close",function(){return mbpWidgets.close($(this).closest("div.widget")),!1}),i.children(".widget").each(function(){$("p.widget-error",this).length&&$("a.widget-action",this).click()}),$("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:5,containment:"document",start:function(e,i){i.helper.find("div.widget-description").hide()},stop:function(i,t){e&&$(e).hide(),e=""}}),i.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"document",start:function(e,i){i.item.children(".widget-inside").hide()},stop:function(e,i){if(i.item.hasClass("ui-draggable")&&i.item.data("draggable")&&i.item.draggable("destroy"),i.item.hasClass("deleting"))return mbpWidgets.save(i.item,1,0,1),void i.item.remove();var t=i.item.find("input.create").val(),d=i.item.find("input.instance_number").val(),s=i.item.find("input.widget-id").val(),a=$(this).attr("id");if(t)return i.item.html(i.item.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,d)})),i.item.attr("id",i.item.find("input.widget-id").val()),d++,$("div#widget-"+s).find("input.instance_number").val(d),mbpWidgets.save(i.item,0,0,1),i.item.find("input.create").val(""),void i.item.find("a.widget-action").click();mbpWidgets.saveOrder(a)},receive:function(e,i){$(this).is(":visible")||$(this).sortable("cancel")}}).sortable("option","connectWith","div.widgets-sortables").parent().filter(".closed").children(".widgets-sortables").sortable("disable"),$("#available-widgets").droppable({tolerance:"pointer",accept:function(e){return"widget-list"!=$(e).parent().attr("id")},drop:function(e,i){i.draggable.addClass("deleting"),$("#removing-widget").hide().children("span").html("")},over:function(e,i){i.draggable.addClass("deleting"),$("div.widget-placeholder").hide(),i.draggable.hasClass("ui-sortable-helper")&&$("#removing-widget").show().children("span").html(i.draggable.find("div.widget-title").children("h4").html())},out:function(e,i){i.draggable.removeClass("deleting"),$("div.widget-placeholder").show(),$("#removing-widget").hide().children("span").html("")}})},saveOrder:function(e){e&&$("#"+e).closest("div.widgets-holder-wrap").find("img.ajax-feedback").css("visibility","visible");var i={action:"widgets-order",widgetAreas:[]};$("div.widgets-sortables").each(function(){i["widgetAreas["+$(this).attr("id")+"]"]=$(this).sortable("toArray").join(",")}),$.post(SITE_URL+"/ajax.php",i,function(){$(".ajax-feedback img").css("visibility","hidden")})},save:function(e,i,t,d){var s,a=e.closest("div.widgets-sortables").attr("id"),n=e.find("form").serialize();e=$(e),$(".ajax-feedback img",e).css("visibility","visible"),$(".ajax-feedback span",e).html(""),s={action:"save-widget",area:a},i&&(s.delete_widget=1),n+="&"+$.param(s),$.post(SITE_URL+"/ajax.php",n,function(s){i?t?(d=0,e.slideUp("fast",function(){$(this).remove(),mbpWidgets.saveOrder()})):e.remove():($(".ajax-feedback img").css("visibility","hidden"),s&&s.length>2&&$(".ajax-feedback span",e).html(s)),d&&mbpWidgets.saveOrder()})},close:function(e){e.children(".widget-inside").slideUp("fast")},collapse:function(e){var i=$(e).siblings(".widgets-sortables"),t=$(e).parent();t.hasClass("closed")?(t.removeClass("closed"),i.sortable("enable").sortable("refresh")):(i.sortable("disable"),t.addClass("closed"))}};